# Amily 酒馆管理器 - 功能扩展方案 v2.0

## 1. 核心功能扩展

### 1.1 多版本共存与切换
**目标**：允许用户同时安装多个版本的 SillyTavern，并能随时切换，方便测试新功能或回退旧版本。

**实现方案**：
*   **目录结构调整**：
    ```text
    data/
    ├── versions/           # 存放各版本程序
    │   ├── 1.12.0/
    │   └── 1.13.4/
    ├── user_data/          # 【新增】公共用户数据区
    │   ├── config.yaml
    │   ├── public/
    │   │   ├── characters/
    │   │   ├── chats/
    │   │   └── ...
    └── current_version.json # 记录当前激活的版本
    ```
*   **切换逻辑**：
    1.  用户在 UI 选择版本点击“切换”。
    2.  后端更新 `current_version.json`。
    3.  启动时，读取配置指向对应版本的 `server.js`。
    4.  **关键点**：启动前，将 `user_data` 中的目录通过 **软链接 (Symlink)** 或 **配置参数** 映射到当前版本目录中，确保数据共享且不丢失。

### 1.2 数据保留与升级/降级
**目标**：在安装新版本或切换版本时，绝不丢失用户的角色卡、聊天记录等数据。

**实现方案**：
*   **首次运行迁移**：检测旧版 `instances/sillytavern`，将其中的用户数据移动到 `data/user_data`。
*   **新版本安装**：
    1.  下载并解压到 `data/versions/{version}`。
    2.  删除新版本自带的默认 `public` 目录中的空文件夹。
    3.  建立软链接指向 `data/user_data`。
*   **降级保护**：虽然数据共享，但如果新版本修改了数据格式，降级可能报错。我们可以在切换前自动备份 `user_data` 到 `backups/` 目录。

### 1.3 团队留言与更新系统
**目标**：建立开发团队与用户的沟通渠道，并强制/提示用户更新启动器。

**实现方案**：
*   **远程配置源**：在 GitHub Gist 或 OSS 上托管一个 `manifest.json`：
    ```json
    {
      "announcement": {
        "title": "重大更新公告",
        "content": "支持多版本切换啦！...",
        "date": "2025-12-14"
      },
      "launcher_update": {
        "latest_version": "1.1.0",
        "download_url": "...",
        "force_update": true,  // true=强更新，false=弱更新
        "changelog": "..."
      }
    }
    ```
*   **启动检查**：软件启动时请求该 JSON。
    *   **强更新**：如果 `force_update` 为 true 且本地版本过低，弹窗遮罩整个界面，仅显示“立即更新”按钮，禁止其他操作。
    *   **弱更新**：在右上角显示“发现新版本”小红点，点击弹出更新日志。

## 2. UI/UX 界面设计变更

### 2.1 侧边栏 (Sidebar)
*   新增 **"公告" (Announcement)** 标签页（如果无新公告可隐藏，有新公告显示红点）。
*   新增 **"版本管理"** 标签页（替代原有的“仪表盘”中的部署部分）。

### 2.2 版本管理页面 (New)
*   **已安装版本列表**：卡片式展示（如 1.13.4, 1.12.0）。
    *   状态标记：`[当前使用]`、`[可更新]`。
    *   操作按钮：`切换至此版本`、`删除`、`备份数据`。
*   **安装新版本**：
    *   下拉框选择版本（从 GitHub API 获取）。
    *   按钮：`下载并安装`。
    *   进度条：显示下载/解压进度。

### 2.3 仪表盘 (Dashboard)
*   **精简**：只保留“启动酒馆”大按钮。
*   **状态栏**：显示“当前版本：1.13.4”、“数据状态：正常”。
*   **快速入口**：打开数据目录、打开备份目录。

### 2.4 公告/留言页面 (New)
*   展示来自 `manifest.json` 的富文本/Markdown 内容。
*   显示开发团队成员名单、捐赠链接等。

## 3. 开发路线图 (Roadmap)

1.  **Phase 1: 数据分离架构 (重构 installer.js)**
    *   实现 `user_data` 目录结构。
    *   编写数据迁移脚本。
    *   修改启动逻辑，支持软链接挂载。

2.  **Phase 2: 多版本管理 UI**
    *   开发“版本管理”页面。
    *   实现版本切换 API。

3.  **Phase 3: 在线更新系统**
    *   搭建远程 JSON 配置。
    *   开发强/弱更新弹窗逻辑。
    *   开发公告页面。

## 4. 按钮与交互细节

*   **[切换版本] 按钮**：点击后，后端修改配置 -> 重启后端服务(如有必要) -> 前端提示“已切换至 v1.12.0”。
*   **[更新启动器] 按钮**：点击后调用默认浏览器打开下载页，或者应用内直接下载更新包并自动运行。
